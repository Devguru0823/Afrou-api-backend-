[{"$match":{"$or":[{"to_id":2149,"from_id":2161},{"to_id":2161,"from_id":2149}],"message_status":{"$ne":"deleted"}}},{"$sort":{"created_date":-1}},{"$limit":20},{"$lookup":{"from":"user","localField":"from_id","foreignField":"user_id","as":"fromUserDetails"}},{"$lookup":{"from":"likes","let":{"messageId":"$message_id"},"pipeline":[{"$match":{"$expr":{"$eq":["$message_id","$$messageId"]}}},{"$match":{"$expr":{"$eq":["$like_type","message"]}}},{"$limit":5},{"$lookup":{"from":"user","localField":"liked_by","foreignField":"user_id","as":"users"}},{"$project":{"_id":0,"user_id":{"$arrayElemAt":["$users.user_id",0]},"first_name":{"$arrayElemAt":["$users.first_name",0]},"last_name":{"$arrayElemAt":["$users.last_name",0]},"profile_image_url":{"$arrayElemAt":["$users.profile_image_url",0]},"user_name":{"$arrayElemAt":["$users.user_name",0]}}}],"as":"liked_by"}},{"$lookup":{"from":"likes","let":{"messageId":"$message_id"},"pipeline":[{"$match":{"$expr":{"$eq":["$message_id","$$messageId"]}}},{"$match":{"$expr":{"$eq":["$liked_by",2149]}}},{"$group":{"_id":null,"count":{"$sum":1}}}],"as":"liked"}},{"$project":{"to_id":1,"message_text":1,"message_image":1,"from_id":1,"message_status":1,"created_date":1,"message_id":1,"from_user.first_name":{"$arrayElemAt":["$fromUserDetails.first_name",0]},"from_user.last_name":{"$arrayElemAt":["$fromUserDetails.last_name",0]},"from_user.user_name":{"$ifNull":[{"$arrayElemAt":["$fromUserDetails.user_name",0]},""]},"from_user.profile_image_url":{"$arrayElemAt":["$fromUserDetails.profile_image_url",0]},"from":{"$cond":[{"$eq":["$from_id",2149]},"me","friend"]},"message_reply_id":1,"message_reply_text":1,"like_count":{"$ifNull":["$like_count",0]},"liked":{"$cond":[{"$eq":[{"$arrayElemAt":["$liked.count",0]},1]},true,false]},"liked_by":1}}]